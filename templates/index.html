{% set active_page = "Papers" %}
{% set page_title = "Papers" %}

{% extends "base.html" %}
{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.4.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>

<script src="static/js/modules/icons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

{% endblock %}

{% block tabs %}
{% endblock %}

{% block content %}
<div class="row p-3"></div>

<!-- Main Heading -->
<div class="row">
    <div class="col-12 text-center">
        <h2>What Do People Use ChatGPT For?</h2>
    </div>
</div>

<!-- Links to Paper and Dataset -->
<div class="row">
    <div class="col-12 text-center">
        <a href="https://arxiv.org/abs/2405.01470" target="_blank" class="btn btn-outline-primary m-2">WildChat Paper</a>
        <a href="https://huggingface.co/datasets/allenai/WildChat-1M" target="_blank" class="btn btn-outline-primary m-2">WildChat Dataset</a>
	<a href="https://huggingface.co/spaces/yuntian-deng/ChatGPT4" target="_blank" class="btn btn-outline-primary m-2">Free GPT-4 Chatbot</a>
    </div>
</div>

<!-- Filters -->
<div class="row">
    <div class="col-12 col-sm-12 col-md-6 col-lg-4">
        <div class="input-group mb-3">
            <input type="text" class="form-control typeahead_all filter-input" id="search-input" placeholder="Keyword Search" value="{{ query }}">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary add-filter" type="button" data-filter="query">+</button>
            </div>
        </div>
    </div>
<!-- Additional Filters -->
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <select id="filter-toxic" class="form-control filter-input">
                <option value="">Toxic</option>
                <option value="true" {% if filters.toxic == 'true' %}selected{% endif %}>True</option>
                <option value="false" {% if filters.toxic == 'false' %}selected{% endif %}>False</option>
            </select>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="toxic">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <input type="text" id="filter-hashed-ip" class="form-control filter-input" placeholder="Hashed IP" value="{{ filters.hashed_ip }}">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="hashed_ip">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <input type="text" id="filter-language" class="form-control filter-input" placeholder="Language" value="{{ filters.language }}">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="language">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <input type="text" id="filter-country" class="form-control filter-input" placeholder="Country" value="{{ filters.country }}">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="country">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <input type="text" id="filter-state" class="form-control filter-input" placeholder="State" value="{{ filters.state }}">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="state">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <input type="number" id="filter-min-turns" class="form-control filter-input" placeholder="Min Turns" value="{{ filters.min_turns }}">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="min_turns">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <select id="filter-model" class="form-control filter-input">
                <option value="">Model</option>
                <option value="gpt-4-1106-preview" {% if filters.model == 'gpt-4-1106-preview' %}selected{% endif %}>gpt-4-1106-preview</option>
                <option value="gpt-4-0314" {% if filters.model == 'gpt-4-0314' %}selected{% endif %}>gpt-4-0314</option>
                <option value="gpt-3.5-turbo-0613" {% if filters.model == 'gpt-3.5-turbo-0613' %}selected{% endif %}>gpt-3.5-turbo-0613</option>
                <option value="gpt-3.5-turbo-0301" {% if filters.model == 'gpt-3.5-turbo-0301' %}selected{% endif %}>gpt-3.5-turbo-0301</option>
                <option value="gpt-3.5-turbo-0125" {% if filters.model == 'gpt-3.5-turbo-0125' %}selected{% endif %}>gpt-3.5-turbo-0125</option>
            </select>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="model">+</button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <div class="input-group mb-3">
            <select id="filter-redacted" class="form-control filter-input">
                <option value="">Redacted</option>
                <option value="true" {% if filters.redacted == 'true' %}selected{% endif %}>True</option>
                <option value="false" {% if filters.redacted == 'false' %}selected{% endif %}>False</option>
            </select>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary add-filter" type="button" data-filter="redacted">+</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div id="current-filters">
            <h5>Filters Applied:</h5>
            <ul class="list-inline">
                {% if query %}
                <li class="list-inline-item">
                  <span class="badge badge-primary">
                    Keyword: {{ query }}
                    <a href="javascript:void(0)" class="remove-filter btn btn-outline-secondary" data-filter="query">&times;</a>
                  </span>
                </li>
                {% endif %}
                {% for key, value in filters.items() %}
                    {% if value %}
                    <li class="list-inline-item">
                      <span class="badge badge-primary">
                        {{ key|capitalize }}: {{ value }}
                        <a href="javascript:void(0)" class="remove-filter btn btn-outline-secondary" data-filter="{{ key }}">&times;</a>
                      </span>
                    </li>
                    {% endif %}
                {% endfor %}
                {% if not query and not any_filters %}
                <li class="list-inline-item">
                <span class="badge badge-secondary">None</span>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Cards -->
<div class="cards row">
{% for conversation in conversations %}
    <div class="myCard col-xs-6 col-md-4">
        <div class="pp-card pp-mode-detail ">
            <div class="pp-card-header-metadata" style="">
		<h6 class="card-subtitle">{{ conversation.conversation_hash }}</h6>
                <h6 class="card-subtitle text-muted" style="margin-top: 0; overflow-x: auto;">Time: {{ conversation.timestamp }}</h6>
		<h6 class="card-subtitle text-muted" style="margin-top: 0">
                    <a href="?state={{ conversation.state }}&country={{ conversation.country }}">{{ conversation.state }}</a>,
                    <a href="?country={{ conversation.country }}">{{ conversation.country }}</a>
                </h6>
                <h6 class="card-subtitle text-muted" style="margin-top: 0; overflow-x: auto;"><a href="?hashed_ip={{ conversation.hashed_ip }}">IP Hash: {{ conversation.hashed_ip }}</a></h6>
                <h6 class="card-subtitle text-muted" style="margin-top: 0; overflow-x: auto;"><a href="?model={{ conversation.model }}">Model: {{ conversation.model }}</a></h6>
            </div>
            <div class="pp-card-header" style="overflow-y: auto;">
                <div class="chat-container">
                    {% for message in conversation.conversation %}
                    <div class="messages {% if message.role == 'user' %}mine{% else %}yours{% endif %}">
                        <div class="message last">{{ message.content|nl2br }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endfor %}
</div>

<!-- Pagination -->
<div class="row">
  <div class="col-12">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item disabled">
          <span class="page-link">Total Results: {% if total >= 10000 %}&ge; 10000{% else %}{{ total }}{% endif %}</span>
        </li>
        {% for page_num in pages %}
          {% if page_num == '...' %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% else %}
            <li class="page-item {% if page_num == page %}active{% endif %}">
            <a class="page-link" href="{% set params = [] %}{% if query %}{% do params.append('query=' ~ query|urlencode) %}{% endif %}{% for key, value in filters.items() if value %}{% do params.append(key ~ '=' ~ value|urlencode) %}{% endfor %}{% if page_num != 1 %}{% do params.append('page=' ~ page_num) %}{% endif %}{% if params|length > 0 %}?{{ params|join('&') }}{% endif %}">{{ page_num }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>
  </div>
</div>

<script src="static/js/modules/urlParams.js"></script>
<script src="static/js/modules/typeaheadSetup.js"></script>
<script src="static/js/modules/lazyLoad.js"></script>
<script src="static/js/data/persistor.js"></script>
<script src="static/js/data/wrangle.js"></script>
<!--script src="static/js/views/papers.js"></script-->
<script>
  $(document).ready(function () {
    //tippy("[data-tippy-content]", { trigger: "mouseenter focus" });
    //start();
    function updateUrlParams() {
      let urlParams = new URLSearchParams(window.location.search);
      // Get the raw values directly from the input fields
      let query = $('#search-input').val();
      if (query) {
        urlParams.set('query', query);
      } else {
        urlParams.delete('query');
      }

      let toxic = $('#filter-toxic').val();
      if (toxic) {
        urlParams.set('toxic', toxic);
      } else {
        urlParams.delete('toxic');
      }

      let model = $('#filter-model').val();
      if (model) {
        urlParams.set('model', model);
      } else {
        urlParams.delete('model');
      }

      let redacted = $('#filter-redacted').val();
      if (redacted) {
        urlParams.set('redacted', redacted);
      } else {
        urlParams.delete('redacted');
      }

      let hashedIp = $('#filter-hashed-ip').val();
      if (hashedIp) {
        urlParams.set('hashed_ip', hashedIp);
      } else {
        urlParams.delete('hashed_ip');
      }

      let language = $('#filter-language').val();
      if (language) {
        urlParams.set('language', language);
      } else {
        urlParams.delete('language');
      }

      let country = $('#filter-country').val();
      if (country) {
        urlParams.set('country', country);
      } else {
        urlParams.delete('country');
      }

      let state = $('#filter-state').val();
      if (state) {
        urlParams.set('state', state);
      } else {
        urlParams.delete('state');
      }

      let minTurns = $('#filter-min-turns').val();
      if (minTurns) {
        urlParams.set('min_turns', minTurns);
      } else {
        urlParams.delete('min_turns');
      }

      // Reset the page number to 1 when updating filters
      urlParams.set('page', 1);
      urlParams.delete('page');
      let queryString = Array.from(urlParams.entries())
                          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                          .join('&');
      window.location.search = queryString;
    }

    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        updateUrlParams();
      }
    }

    function checkInputs() {
        $('.filter-input').each(function () {
            let $input = $(this);
            let $button = $input.parent().find('.add-filter');
            if ($input.val().trim() === '') {
                $button.prop('disabled', true);
            } else {
                $button.prop('disabled', false);
            }
        });
    }

    // Function to set form values based on URL parameters
    function setFormValuesFromUrlParams() {
        let urlParams = new URLSearchParams(window.location.search);
        $('#search-input').val(decodeURIComponent(urlParams.get('query') || ''));
        $('#filter-toxic').val(decodeURIComponent(urlParams.get('toxic') || ''));
        $('#filter-redacted').val(decodeURIComponent(urlParams.get('redacted') || ''));
        $('#filter-model').val(decodeURIComponent(urlParams.get('model') || ''));
        $('#filter-hashed-ip').val(decodeURIComponent(urlParams.get('hashed_ip') || ''));
        $('#filter-language').val(decodeURIComponent(urlParams.get('language') || ''));
        $('#filter-country').val(decodeURIComponent(urlParams.get('country') || ''));
        $('#filter-state').val(decodeURIComponent(urlParams.get('state') || ''));
        $('#filter-min-turns').val(decodeURIComponent(urlParams.get('min_turns') || ''));
    }

    // Set form values on page load
    setFormValuesFromUrlParams();

    // Initial check
    checkInputs();
    $('.filter-input').on('keyup change', checkInputs);
    $('.add-filter').click(updateUrlParams);
    $('.filter-input').on('keypress', handleEnterKey);

    $('.remove-filter').click(function() {
      let filter = $(this).data('filter');
      let urlParams = new URLSearchParams(window.location.search);
      urlParams.delete(filter);
      urlParams.set('page', 1);
      urlParams.delete('page');
      let queryString = Array.from(urlParams.entries())
                          .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                          .join('&');
      window.location.search = queryString;
    });

    $('.typeahead_all_clear').click(function() {
      window.location.href = '/';
    });
  });
</script>

{% endblock %}

{% block footer %}

{% endblock %}
